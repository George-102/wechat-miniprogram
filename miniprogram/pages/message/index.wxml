<view class="message-page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-nav" style="height: {{customNavHeight}}px">
    <view class="nav-content" style="height: 44px; padding-top: {{statusBarHeight}}px">
      <text class="nav-title">æ¶ˆæ¯</text>
      <view class="nav-actions">
        <view class="nav-btn" bind:tap="onChatTap">
          <text class="btn-icon">ğŸ’¬</text>
        </view>
        <view class="nav-btn" bind:tap="onClearAll">
          <text class="btn-icon">ğŸ—‘ï¸</text>
        </view>
      </view>
    </view>
  </view>

  <view class="message-container" style="padding-top: {{customNavHeight}}px">
    <!-- æ ‡ç­¾å¯¼èˆª -->
    <view class="message-tabs">
      <view class="tabs-container">
        <block wx:for="{{tabs}}" wx:key="id">
          <view 
            class="tab-item {{activeTab === item.id ? 'active' : ''}}"
            data-tab="{{item.id}}"
            bind:tap="onTabTap"
          >
            <text class="tab-name">{{item.name}}</text>
            <view class="tab-indicator"></view>
            <view class="unread-badge" wx:if="{{item.id === 'unread' && unreadCount > 0}}">
              {{unreadCount > 99 ? '99+' : unreadCount}}
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-list">
      <block wx:for="{{messages}}" wx:key="_id">
        <view 
          class="message-item {{item.isRead ? '' : 'unread'}}"
          data-message="{{item}}"
          bind:tap="onMessageTap"
        >
          <!-- æ¶ˆæ¯å›¾æ ‡ -->
          <view class="message-icon">
            <text class="icon">{{this.getMessageIcon(item.type)}}</text>
            <view class="unread-dot" wx:if="{{!item.isRead}}"></view>
          </view>

          <!-- æ¶ˆæ¯å†…å®¹ -->
          <view class="message-content">
            <view class="message-header">
              <text class="message-title">{{item.title}}</text>
              <text class="message-time">{{item.createTime}}</text>
            </view>
            <view class="message-body">
              <text class="message-text {{item.isExpanded ? 'expanded' : ''}}">
                {{item.content}}
              </text>
              <text 
                class="expand-btn" 
                wx:if="{{item.type === 'system' && item.content.length > 60}}"
                bind:tap="toggleMessageExpand"
                data-messageid="{{item._id}}"
              >
                {{item.isExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}
              </text>
            </view>
            <view class="message-extra" wx:if="{{item.extraInfo}}">
              <text class="extra-text">{{item.extraInfo}}</text>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="message-actions">
            <view 
              class="action-btn read-btn" 
              wx:if="{{!item.isRead}}"
              data-messageid="{{item._id}}"
              bind:tap="markAsRead"
            >
              <text class="action-text">æ ‡ä¸ºå·²è¯»</text>
            </view>
            <view 
              class="action-btn delete-btn" 
              data-messageid="{{item._id}}"
              bind:tap="onDeleteMessage"
            >
              <text class="action-text">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading && messages.length > 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && messages.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && messages.length === 0}}">
      <text class="empty-icon">ğŸ’Œ</text>
      <text class="empty-text">æš‚æ— æ¶ˆæ¯</text>
      <text class="empty-desc">å½“æœ‰æ–°æ¶ˆæ¯æ—¶ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</text>
    </view>
  </view>
</view>